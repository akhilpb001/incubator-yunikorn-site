(window.webpackJsonp=window.webpackJsonp||[]).push([[101],{156:function(e,n,a){"use strict";a.r(n),a.d(n,"frontMatter",(function(){return i})),a.d(n,"metadata",(function(){return c})),a.d(n,"rightToc",(function(){return u})),a.d(n,"default",(function(){return l}));var t=a(2),o=a(6),r=(a(0),a(164)),i={id:"resource_quota_management",title:"Resource Quota Management"},c={unversionedId:"user_guide/resource_quota_management",id:"user_guide/resource_quota_management",isDocsHomePage:!1,title:"Resource Quota Management",description:"\x3c!--",source:"@site/docs/user_guide/resource_quota_mgmt.md",slug:"/user_guide/resource_quota_management",permalink:"/docs/next/user_guide/resource_quota_management",version:"current",sidebar:"docs",previous:{title:"ACLs",permalink:"/docs/next/user_guide/acls"},next:{title:"Run Spark Jobs",permalink:"/docs/next/user_guide/workloads/run_spark"}},u=[{value:"Option 1) Static queues",id:"option-1-static-queues",children:[{value:"Goal",id:"goal",children:[]},{value:"Configuration",id:"configuration",children:[]},{value:"Run workloads",id:"run-workloads",children:[]}]},{value:"Option 2) 1:1 mapping from namespaces to queues",id:"option-2-11-mapping-from-namespaces-to-queues",children:[{value:"Goal",id:"goal-1",children:[]},{value:"Configuration",id:"configuration-1",children:[]},{value:"Set up namespaces",id:"set-up-namespaces",children:[]},{value:"Run workloads",id:"run-workloads-1",children:[]}]},{value:"Option 3) Hierarchy queues with dynamical leaves that mapped to namespaces",id:"option-3-hierarchy-queues-with-dynamical-leaves-that-mapped-to-namespaces",children:[{value:"Goal",id:"goal-2",children:[]},{value:"Configuration",id:"configuration-2",children:[]},{value:"Set up namespaces",id:"set-up-namespaces-1",children:[]},{value:"Run workloads",id:"run-workloads-2",children:[]}]}],s={rightToc:u};function l(e){var n=e.components,a=Object(o.a)(e,["components"]);return Object(r.b)("wrapper",Object(t.a)({},s,a,{components:n,mdxType:"MDXLayout"}),Object(r.b)("p",null,"YuniKorn can offer more fine-grained resource quota management comparing to simply\nusing namespace resource quota. Here are some how-to documents about setting up\nresource quota management with YuniKorn queues."),Object(r.b)("h2",{id:"option-1-static-queues"},"Option 1) Static queues"),Object(r.b)("h3",{id:"goal"},"Goal"),Object(r.b)("p",null,"Pre-setup a hierarchy of queues with min/max capacity, users can only submit\njobs to the leaf queues. This approach fully manages the resource capacity for\neach of the queues, which is suitable to the scenarios that queues do not change\ntoo often."),Object(r.b)("h3",{id:"configuration"},"Configuration"),Object(r.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(r.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-heading"}),Object(r.b)("h5",{parentName:"div"},Object(r.b)("span",Object(t.a)({parentName:"h5"},{className:"admonition-icon"}),Object(r.b)("svg",Object(t.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(r.b)("path",Object(t.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(r.b)("div",Object(t.a)({parentName:"div"},{className:"admonition-content"}),Object(r.b)("p",{parentName:"div"},"The following configuration is an example to demonstrate the format,\nyou need to setup the queue hierarchy based on your own structure and capacity,"))),Object(r.b)("p",null,"Apply the following configuration to YuniKorn's configmap:"),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-yaml"}),"partitions:\n  -\n    name: default\n    queues:\n      -\n        name: root\n        submitacl: '*'\n        queues:\n          -\n            name: advertisement\n            resources:\n              guaranteed:\n                memory: 500000\n                vcore: 50000\n              max:\n                memory: 800000\n                vcore: 80000\n          -\n            name: search\n            resources:\n              guaranteed:\n                memory: 400000\n                vcore: 40000\n              max:\n                memory: 600000\n                vcore: 60000\n          -\n            name: sandbox\n            resources:\n              guaranteed:\n                memory: 100000\n                vcore: 10000\n              max:\n                memory: 100000\n                vcore: 10000\n")),Object(r.b)("p",null,"in this example, we are going to setup 3 queues under root, and each of them has\na specific min/max capacity set up."),Object(r.b)("h3",{id:"run-workloads"},"Run workloads"),Object(r.b)("p",null,"In order to run jobs in specific queues, you will need to set the following label in all pods' spec:"),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-yaml"}),'labels:\n  app: my-test-app\n  applicationId: " my-test-app-01"\n  queue: root.sandbox\n')),Object(r.b)("h2",{id:"option-2-11-mapping-from-namespaces-to-queues"},"Option 2) 1:1 mapping from namespaces to queues"),Object(r.b)("h3",{id:"goal-1"},"Goal"),Object(r.b)("p",null,"User just needs to setup namespaces, YuniKorn automatically maps each namespace to an internal resource queue (AKA dynamical queue).\nThere is no additional steps to create YuniKorn queues, all queues will be created dynamically,\nresource allocation and quotas will be managed by YuniKorn instead of the namespace resource quota."),Object(r.b)("h3",{id:"configuration-1"},"Configuration"),Object(r.b)("p",null,"Apply the following configuration to YuniKorn's configmap:"),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-yaml"}),"partitions:\n  -\n    name: default\n    placementrules:\n      - name: tag\n        value: namespace\n        create: true\n    queues:\n      - name: root\n        submitacl: '*'\n        properties:\n          application.sort.policy: stateaware\n\n")),Object(r.b)("p",null,"Note, the property ",Object(r.b)("inlineCode",{parentName:"p"},"application.sort.policy")," in this configuration is set to\n",Object(r.b)("inlineCode",{parentName:"p"},"stateaware"),". This is a simple app sorting policy applicable for batch jobs, you\ncan find more document ",Object(r.b)("a",Object(t.a)({parentName:"p"},{href:"/docs/next/user_guide/sorting_policies#StateAwarePolicy"}),"here"),"."),Object(r.b)("p",null,"You can do this during the installation by overwriting the configuration in the\n",Object(r.b)("a",Object(t.a)({parentName:"p"},{href:"https://github.com/apache/incubator-yunikorn-release/blob/724ec82d0d548598e170cc6d5ca6aaae00f8286c/helm-charts/yunikorn/values.yaml#L71-L81"}),"helm chart template"),"."),Object(r.b)("h3",{id:"set-up-namespaces"},"Set up namespaces"),Object(r.b)("p",null,"Continue to create namespaces like before, do not create namespace quota anymore.\nInstead, set the following annotation in the namespace object:"),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-yaml"}),'yunikorn.apache.org/namespace.max.cpu: "64"\nyunikorn.apache.org/namespace.max.memory: "100Gi"\n')),Object(r.b)("p",null,"YuniKorn will parse the annotation and set the max capacity of the dynamical queue\nthat mapped to this namespace to 64 CPU and 100GB memory."),Object(r.b)("h3",{id:"run-workloads-1"},"Run workloads"),Object(r.b)("p",null,"Jobs continue to be submitted to namespaces, based on the ",Object(r.b)("inlineCode",{parentName:"p"},"Placementrule")," used\nin the configuration. YuniKorn will automatically run the job and all its pods in\nthe corresponding queue. For example, if a job is submitted to namespace ",Object(r.b)("inlineCode",{parentName:"p"},"development"),",\nthen you will see the job is running in ",Object(r.b)("inlineCode",{parentName:"p"},"root.development")," queue."),Object(r.b)("h2",{id:"option-3-hierarchy-queues-with-dynamical-leaves-that-mapped-to-namespaces"},"Option 3) Hierarchy queues with dynamical leaves that mapped to namespaces"),Object(r.b)("h3",{id:"goal-2"},"Goal"),Object(r.b)("p",null,"Though the tag placement rule using the ",Object(r.b)("inlineCode",{parentName:"p"},"namespace")," tag is capable of putting applications based on the name of the namespace, sometimes more dynamic placement is required."),Object(r.b)("p",null,"Users can annotate namespaces which allows dynamic placement of applications based on the annotation value if proper placement rules are present."),Object(r.b)("h3",{id:"configuration-2"},"Configuration"),Object(r.b)("p",null,"Apply the following configuration to YuniKorn's configmap:"),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-yaml"}),"placementrules:\n - name: tag\n   value: namespace\n   create: true\n   parent:\n     - name: tag\n       value: namespace.parentqueue\nqueues:\n - name: root\n   queues:\n     - name: production\n     - name: development\n\n")),Object(r.b)("p",null,"The ",Object(r.b)("inlineCode",{parentName:"p"},"namespace.parentqueue")," tag is provided by the shim (see next section)."),Object(r.b)("p",null,"You can do this during the installation by overwriting the configuration in the\n",Object(r.b)("a",Object(t.a)({parentName:"p"},{href:"https://github.com/apache/incubator-yunikorn-release/blob/724ec82d0d548598e170cc6d5ca6aaae00f8286c/helm-charts/yunikorn/values.yaml#L71-L81"}),"helm chart template"),"."),Object(r.b)("h3",{id:"set-up-namespaces-1"},"Set up namespaces"),Object(r.b)("p",null,"You can configure the following annotation for a Kubernetes namespace in your cluster: ",Object(r.b)("inlineCode",{parentName:"p"},"yunikorn.apache.org/parentqueue"),"."),Object(r.b)("p",null,"E.g. ",Object(r.b)("inlineCode",{parentName:"p"},"finance")," namespace can be annotated with the following annotation:"),Object(r.b)("pre",null,Object(r.b)("code",Object(t.a)({parentName:"pre"},{className:"language-yaml"}),"yunikorn.apache.org/parentqueue: root.production\n")),Object(r.b)("p",null,"Each pod (allocation) created in the namespace will be passed to the scheduler with the value of that annotation under the ",Object(r.b)("inlineCode",{parentName:"p"},"namespace.parentqueue")," tag."),Object(r.b)("p",null,"This tag can be further used in the tag placement rule to provide the desired mapping as seen above in the Configuration section."),Object(r.b)("h3",{id:"run-workloads-2"},"Run workloads"),Object(r.b)("p",null,"After the configmap has been configured and the namespace has been annotated, users simply submit applications to the namespace and the placement rule will take effect."),Object(r.b)("p",null,"Let's say a user submits an application to the ",Object(r.b)("inlineCode",{parentName:"p"},"finance")," namespace. The application will be placed onto ",Object(r.b)("inlineCode",{parentName:"p"},"root.production.finance")," based on the configs above."))}l.isMDXComponent=!0},164:function(e,n,a){"use strict";a.d(n,"a",(function(){return p})),a.d(n,"b",(function(){return d}));var t=a(0),o=a.n(t);function r(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function i(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function c(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?i(Object(a),!0).forEach((function(n){r(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function u(e,n){if(null==e)return{};var a,t,o=function(e,n){if(null==e)return{};var a,t,o={},r=Object.keys(e);for(t=0;t<r.length;t++)a=r[t],n.indexOf(a)>=0||(o[a]=e[a]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(t=0;t<r.length;t++)a=r[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=o.a.createContext({}),l=function(e){var n=o.a.useContext(s),a=n;return e&&(a="function"==typeof e?e(n):c(c({},n),e)),a},p=function(e){var n=l(e.components);return o.a.createElement(s.Provider,{value:n},e.children)},m={inlineCode:"code",wrapper:function(e){var n=e.children;return o.a.createElement(o.a.Fragment,{},n)}},b=o.a.forwardRef((function(e,n){var a=e.components,t=e.mdxType,r=e.originalType,i=e.parentName,s=u(e,["components","mdxType","originalType","parentName"]),p=l(a),b=t,d=p["".concat(i,".").concat(b)]||p[b]||m[b]||r;return a?o.a.createElement(d,c(c({ref:n},s),{},{components:a})):o.a.createElement(d,c({ref:n},s))}));function d(e,n){var a=arguments,t=n&&n.mdxType;if("string"==typeof e||t){var r=a.length,i=new Array(r);i[0]=b;var c={};for(var u in n)hasOwnProperty.call(n,u)&&(c[u]=n[u]);c.originalType=e,c.mdxType="string"==typeof e?e:t,i[1]=c;for(var s=2;s<r;s++)i[s]=a[s];return o.a.createElement.apply(null,i)}return o.a.createElement.apply(null,a)}b.displayName="MDXCreateElement"}}]);